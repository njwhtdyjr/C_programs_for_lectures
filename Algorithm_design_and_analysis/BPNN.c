// Code file created by C Code Develop

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>
#include <graphics.h>
#include <conio.h>

const double x[300]={-1.0, -0.99331104, -0.98662207, -0.97993311, -0.97324415, -0.96655518, 
    -0.95986622, -0.95317726, -0.94648829, -0.93979933, -0.93311037, -0.9264214, 
    -0.91973244, -0.91304348, -0.90635452, -0.89966555, -0.89297659, -0.88628763, 
    -0.87959866, -0.8729097, -0.86622074, -0.85953177, -0.85284281, -0.84615385, 
    -0.83946488, -0.83277592, -0.82608696, -0.81939799, -0.81270903, -0.80602007, 
    -0.7993311, -0.79264214, -0.78595318, -0.77926421, -0.77257525, -0.76588629, 
    -0.75919732, -0.75250836, -0.7458194, -0.73913043, -0.73244147, -0.72575251, 
    -0.71906355, -0.71237458, -0.70568562, -0.69899666, -0.69230769, -0.68561873, 
    -0.67892977, -0.6722408, -0.66555184, -0.65886288, -0.65217391, -0.64548495, 
    -0.63879599, -0.63210702, -0.62541806, -0.6187291, -0.61204013, -0.60535117, 
    -0.59866221, -0.59197324, -0.58528428, -0.57859532, -0.57190635, -0.56521739, 
    -0.55852843, -0.55183946, -0.5451505, -0.53846154, -0.53177258, -0.52508361, 
    -0.51839465, -0.51170569, -0.50501672, -0.49832776, -0.4916388, -0.48494983, 
    -0.47826087, -0.47157191, -0.46488294, -0.45819398, -0.45150502, -0.44481605, 
    -0.43812709, -0.43143813, -0.42474916, -0.4180602, -0.41137124, -0.40468227, -0.39799331, -0.39130435, -0.38461538, -0.37792642, -0.37123746, -0.36454849, 
    -0.35785953, -0.35117057, -0.34448161, -0.33779264, -0.33110368, -0.32441472, 
    -0.31772575, -0.31103679, -0.30434783, -0.29765886, -0.2909699, -0.28428094, 
    -0.27759197, -0.27090301, -0.26421405, -0.25752508, -0.25083612, -0.24414716, 
    -0.23745819, -0.23076923, -0.22408027, -0.2173913, -0.21070234, -0.20401338, 
    -0.19732441, -0.19063545, -0.18394649, -0.17725753, -0.17056856, -0.1638796, 
    -0.15719064, -0.15050167, -0.14381271, -0.13712375, -0.13043478, -0.12374582, 
    -0.11705686, -0.11036789, -0.10367893, -0.09698997, -0.090301, -0.08361204, 
    -0.07692308, -0.07023411, -0.06354515, -0.05685619, -0.05016722, -0.04347826, 
    -0.0367893, -0.03010033, -0.02341137, -0.01672241, -0.01003344, -0.00334448, 
    0.00334448, 0.01003344, 0.01672241, 0.02341137, 0.03010033, 0.0367893, 
    0.04347826, 0.05016722, 0.05685619, 0.06354515, 0.07023411, 0.07692308, 
    0.08361204, 0.090301, 0.09698997, 0.10367893, 0.11036789, 0.11705686, 
    0.12374582, 0.13043478, 0.13712375, 0.14381271, 0.15050167, 0.15719064, 
    0.1638796, 0.17056856, 0.17725753, 0.18394649, 0.19063545, 0.19732441, 
    0.20401338, 0.21070234, 0.2173913, 0.22408027, 0.23076923, 0.23745819, 
    0.24414716, 0.25083612, 0.25752508, 0.26421405, 0.27090301, 0.27759197, 
    0.28428094, 0.2909699, 0.29765886, 0.30434783, 0.31103679, 0.31772575, 0.32441472, 0.33110368, 0.33779264, 0.34448161, 0.35117057, 0.35785953, 
    0.36454849, 0.37123746, 0.37792642, 0.38461538, 0.39130435, 0.39799331, 
    0.40468227, 0.41137124, 0.4180602, 0.42474916, 0.43143813, 0.43812709, 
    0.44481605, 0.45150502, 0.45819398, 0.46488294, 0.47157191, 0.47826087, 
    0.48494983, 0.4916388, 0.49832776, 0.50501672, 0.51170569, 0.51839465, 
    0.52508361, 0.53177258, 0.53846154, 0.5451505, 0.55183946, 0.55852843, 
    0.56521739, 0.57190635, 0.57859532, 0.58528428, 0.59197324, 0.59866221, 
    0.60535117, 0.61204013, 0.6187291, 0.62541806, 0.63210702, 0.63879599, 
    0.64548495, 0.65217391, 0.65886288, 0.66555184, 0.6722408, 0.67892977, 
    0.68561873, 0.69230769, 0.69899666, 0.70568562, 0.71237458, 0.71906355, 
    0.72575251, 0.73244147, 0.73913043, 0.7458194, 0.75250836, 0.75919732, 
    0.76588629, 0.77257525, 0.77926421, 0.78595318, 0.79264214, 0.7993311, 
    0.80602007, 0.81270903, 0.81939799, 0.82608696, 0.83277592, 0.83946488, 
    0.84615385, 0.85284281, 0.85953177, 0.86622074, 0.8729097, 0.87959866, 
    0.88628763, 0.89297659, 0.89966555, 0.90635452, 0.91304348, 0.91973244, 
    0.9264214, 0.93311037, 0.93979933, 0.94648829, 0.95317726, 0.95986622, 
    0.96655518, 0.97324415, 0.97993311, 0.98662207, 0.99331104, 1.};
const double y[300]={1.32321232, 1.32288175, 1.3362434, 1.34088565, 1.35168796, 1.35167861, 
    1.34974211, 1.381399, 1.37507093, 1.42275319, 1.3660485, 1.43382583, 
    1.38474964, 1.41147843, 1.38991848, 1.43032586, 1.46240207, 1.46934618, 
    1.45729105, 1.48684881, 1.52334175, 1.49289772, 1.47815395, 1.50932688, 
    1.52552803, 1.49414232, 1.52311295, 1.55440931, 1.5681982, 1.56520523, 
    1.56020511, 1.59252045, 1.56953256, 1.57569429, 1.57281242, 1.63968658, 
    1.65284698, 1.6238359, 1.59919156, 1.64893053, 1.66323877, 1.64670036, 
    1.69957983, 1.68987721, 1.67630665, 1.74163278, 1.7590817, 1.73246389, 
    1.75265049, 1.72843246, 1.75155304, 1.78232499, 1.78593399, 1.84990027, 
    1.79618331, 1.80380332, 1.85725475, 1.83295132, 1.86815151, 1.84176446, 
    1.88843785, 1.86076983, 1.90951459, 1.89968134, 1.93716142, 1.92214366, 
    1.92223627, 1.93917393, 1.9555177, 1.95920589, 1.98529661, 2.00874042, 
    1.99692086, 2.0336524, 2.04033755, 1.99089718, 2.0527712, 2.07857323, 
    2.11465724, 2.06771365, 2.11563283, 2.10950416, 2.12729076, 2.14002303, 
    2.15866118, 2.14702314, 2.19892075, 2.19067067, 2.19444488, 2.22356302, 
    2.18176663, 2.22830494, 2.24032238, 2.28446496, 2.29879652, 2.26613067, 2.32610092, 2.30395885, 2.29798326, 2.33837998, 2.34839776, 2.38435855, 
    2.38001806, 2.38501901, 2.42033689, 2.44149238, 2.45499173, 2.43366507, 
    2.47285519, 2.4335458, 2.49708206, 2.46862004, 2.50109119, 2.49481297, 
    2.51540545, 2.54336406, 2.54398732, 2.55662834, 2.58663676, 2.58899802, 
    2.59536508, 2.62996207, 2.65114295, 2.66034588, 2.64924502, 2.67278086, 
    2.6906382, 2.72054738, 2.72522234, 2.71278702, 2.73006732, 2.75722007, 
    2.76237029, 2.80105379, 2.78404916, 2.79301126, 2.78771137, 2.83745419, 
    2.83592139, 2.86160744, 2.86299675, 2.95337827, 2.8839791, 2.90064489, 
    2.93036305, 2.91817776, 2.95494433, 2.94299181, 2.99644061, 3.01300835, 
    2.99999812, 3.0544968, 3.04326378, 3.08430849, 3.07401923, 3.12355432, 
    3.10065383, 3.09037902, 3.12456118, 3.13866128, 3.15912195, 3.13969782, 
    3.13730533, 3.20424736, 3.17620915, 3.21191017, 3.22524832, 3.22366332, 
    3.24953552, 3.2555648, 3.26765818, 3.27482863, 3.29642267, 3.30503269, 
    3.30192897, 3.35765852, 3.37689125, 3.39100524, 3.35815923, 3.3716495, 3.44788848, 3.389134, 3.41113682, 3.46263737, 3.47228411, 3.47344168, 
    3.44764779, 3.4855247, 3.48088143, 3.51606259, 3.48461439, 3.58239945, 
    3.5506119, 3.59532077, 3.60945655, 3.57963286, 3.62219492, 3.63105312, 
    3.61813008, 3.66372453, 3.63491209, 3.6688169, 3.68866879, 3.71623508, 
    3.69489044, 3.69790867, 3.74220825, 3.72235283, 3.75073686, 3.78188708, 
    3.77700818, 3.78685672, 3.77069925, 3.8040337, 3.82823492, 3.83256351, 
    3.88145919, 3.86782707, 3.87775015, 3.85912213, 3.87961222, 3.89803605, 
    3.92476027, 3.94228933, 3.92125388, 3.94696086, 3.98060097, 3.98425739, 
    3.97402256, 4.01593542, 4.05515961, 4.03560049, 4.06025595, 4.0306823, 
    4.08087948, 4.0870336, 4.0891939, 4.12167055, 4.10371183, 4.09906439, 
    4.17423228, 4.11359881, 4.17467388, 4.19894682, 4.14979655, 4.22949787, 
    4.18096332, 4.21819429, 4.22297337, 4.20617345, 4.23733539, 4.2304062, 
    4.26947805, 4.27969247, 4.27657214, 4.31373448, 4.29163045, 4.34506092, 
    4.35548837, 4.3122509, 4.35838704, 4.37412534, 4.35227404, 4.36645363, 
    4.35827803, 4.40825268, 4.41373435, 4.42301737, 4.44895498, 4.42432367, 
    4.45136504, 4.46931828, 4.46830537, 4.50171939, 4.49593076, 4.47435699, 
    4.52180713, 4.50263985, 4.5269319, 4.5200426, 4.51691522, 4.55273175, 
    4.57248716, 4.55021017, 4.56036422, 4.61000832, 4.57667884, 4.61680108, 
    4.57153846, 4.60042892, 4.60098837, 4.62019532, 4.65032209, 4.65507441, 
    4.68909934, 4.66547796, 4.68139819, 4.68547472, 4.65449069, 4.70699361};

double W1[3][2],W2[3][4],W3[1][4];
double _y[300],A1[300][3],A2[300][3];
double lr=0.1;
double sigmoid(double x);
void forwardpropagation(void);
void backpropagation(void);
double error(void);
void forwardpropagation_for_one_sample(int n);
void backpropagation_for_one_sample(int n);

int main(void)
{  
    for(int i = 0; i < 3; i++)
    {
        for(int j = 0; j < 2; j++)
        {
            W1[i][j] = (double)rand()/RAND_MAX;
        }
    }
    for(int i = 0; i < 3;  i++)
    {
        for(int j = 0; j < 4; j++)
        {
            W2[i][j] = (double)rand()/RAND_MAX;
        }
    }
    for(int i = 0;  i < 4; i++)
    {
        W3[0][i] = (double)rand()/RAND_MAX;
    }
    do {
        forwardpropagation();
        backpropagation();
    } while ( error() > 2e-4
    );
    //绘制图形
    initgraph(250,360,0);
    setbkcolor(WHITE);
    cleardevice();
    setorigin(100,0);

    setcolor(BLUE);
    moveto(-100,0);
    for(int i=0;i<300;i++)
    {
        lineto(100*x[i],100*y[i]-132);
        moveto(100*x[i],100*y[i]-132);
    }
    getch();
    closegraph();

    initgraph(250,360,0);
    setbkcolor(WHITE);
    cleardevice();
    setorigin(100,0);
    setcolor(BLUE);
    
    forwardpropagation_for_one_sample(0);
    moveto(-100,100*_y[0]-132);
    lineto(-100,100*_y[0]-132);
    moveto(-100,100*_y[0]-132);
    for(int i=1;i<300;i++)
    {
        forwardpropagation_for_one_sample(i);
        lineto(100*x[i],100*_y[i]-132);
        moveto(100*x[i],100*_y[i]-132);
    }



/*    do
    {
        for(int i=0;i<300;i++)
        {
            forwardpropagation_for_one_sample(i);
            backpropagation_for_one_sample(i);
            
        }
    }
    while(error()>1e-5);
*/    
    getch();
    closegraph();
    return 0;
}
double sigmoid(double x)
{
    return 1.0/(1.0 + exp(-x));
}

double error(void)
{
    double temp1 = 0;
    for(int i = 0; i < 300; i++)
    {
        temp1+= pow((_y[i]-y[i]),2);
    }
    temp1/= 600;
    printf("%f\n",temp1);
    return temp1;
}
void forwardpropagation_for_one_sample(int n)
{
    for(int j = 0; j < 3; j++)
        {
            A1[n][j] = sigmoid(W1[j][0]*x[n]+W1[j][1]);
        }
        for(int j = 0; j < 3; j++)
        {
            A2[n][j] = sigmoid(W2[j][0]*A1[n][0]+W2[j][1]*A1[n][1]+W2[j][2]*A1[n][2]+W2[j][3]);
        }
        _y[n] = W3[0][0]*A2[n][0]+W3[0][1]*A2[n][1]+W3[0][2]*A2[n][2]+W3[0][3];
}
void backpropagation_for_one_sample(int n)
{
    for(int j = 0; j < 3; j++)
    {
        for(int k = 0; k < 2; k++)
        {
            double temp1 = 0;
            
            
                double temp2 = 0;
                for(int m = 0; m < 3; m++)
                {
                    double temp3 = 0;
                    temp3 = W3[0][m]*A2[n][m]*(1-A2[n][m])*W2[m][j]*A1[n][j]*(1-A1[n][j]);
                    if(k!= 1) temp3*= x[n];
                    temp2+= temp3;
                }
                temp1+= (_y[n]-y[n])*temp2;
            
            temp1/= 300;
            W1[j][k]-= lr*temp1;
        }
    }
    for(int j = 0; j < 3; j++)
    {
        for(int k = 0; k < 4; k++)
        {
            double temp1 = 0;
            
            
                double temp2 = 0;
                temp2 = (_y[n]-y[n])*W3[0][j]*A2[n][j]*(1-A2[n][j]);
                if(k!= 3) temp2*= A1[n][k];
                temp1+= temp2;
            
            temp1/= 300;
            W2[j][k]-= lr*temp1; ;
        }
    }
    for(int j = 0; j < 4; j++)
    {    
        double temp1 = 0;
        
        
            double temp2 = 0;
            temp2 = (_y[n]-y[n]);
            if(j!= 3) temp2*= A2[n][j];
            temp1+= temp2;
        
        temp1/= 300;
        W3[0][j]-= lr*temp1; 
    }
}
void forwardpropagation(void)
{
    for(int i = 0; i < 300; i++)
    {
        for(int j = 0; j < 3; j++)
        {
            A1[i][j] = sigmoid(W1[j][0]*x[i]+W1[j][1]);
        }
        for(int j = 0; j < 3; j++)
        {
            A2[i][j] = sigmoid(W2[j][0]*A1[i][0]+W2[j][1]*A1[i][1]+W2[j][2]*A1[i][2]+W2[j][3]);
        }
        _y[i] = W3[0][0]*A2[i][0]+W3[0][1]*A2[i][1]+W3[0][2]*A2[i][2]+W3[0][3];
    }
}

void backpropagation(void)
{
    for(int j = 0; j < 3; j++)
    {
        for(int k = 0; k < 2; k++)
        {
            double temp1 = 0;
            for(int i = 0; i < 300; i++)
            {
                double temp2 = 0;
                for(int m = 0; m < 3; m++)
                {
                    double temp3 = 0;
                    temp3 = W3[0][m]*A2[i][m]*(1-A2[i][m])*W2[m][j]*A1[i][j]*(1-A1[i][j]);
                    if(k!= 1) temp3*= x[i];
                    temp2+= temp3;
                }
                temp1+= (_y[i]-y[i])*temp2;
            }
            temp1/= 300;
            W1[j][k]-= lr*temp1;
        }
    }
    for(int j = 0; j < 3; j++)
    {
        for(int k = 0; k < 4; k++)
        {
            double temp1 = 0;
            for(int i = 0; i < 300; i++)
            {
                double temp2 = 0;
                temp2 = (_y[i]-y[i])*W3[0][j]*A2[i][j]*(1-A2[i][j]);
                if(k!= 3) temp2*= A1[i][k];
                temp1+= temp2;
            }
            temp1/= 300;
            W2[j][k]-= lr*temp1; ;
        }
    }
    for(int j = 0; j < 4; j++)
    {    
        double temp1 = 0;
        for(int i = 0; i < 300; i++)
        {
            double temp2 = 0;
            temp2 = (_y[i]-y[i]);
            if(j!= 3) temp2*= A2[i][j];
            temp1+= temp2;
        }
        temp1/= 300;
        W3[0][j]-= lr*temp1; ;
    }
}








